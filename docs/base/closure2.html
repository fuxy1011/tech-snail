<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>作用域和闭包 | 蜗牛🐌不牛</title>
    <meta name="description" content="技术方面的沉淀，积累">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    
    <link rel="preload" href="/tech-snail/assets/css/0.styles.4374f152.css" as="style"><link rel="preload" href="/tech-snail/assets/js/app.844d1d9b.js" as="script"><link rel="preload" href="/tech-snail/assets/js/2.79842762.js" as="script"><link rel="preload" href="/tech-snail/assets/js/19.30631a22.js" as="script"><link rel="prefetch" href="/tech-snail/assets/js/10.804001bd.js"><link rel="prefetch" href="/tech-snail/assets/js/11.3e10a738.js"><link rel="prefetch" href="/tech-snail/assets/js/12.beb7b894.js"><link rel="prefetch" href="/tech-snail/assets/js/13.b0449834.js"><link rel="prefetch" href="/tech-snail/assets/js/14.d10dd91a.js"><link rel="prefetch" href="/tech-snail/assets/js/15.eb0ba17a.js"><link rel="prefetch" href="/tech-snail/assets/js/16.5e669cee.js"><link rel="prefetch" href="/tech-snail/assets/js/17.256db3aa.js"><link rel="prefetch" href="/tech-snail/assets/js/18.28b9ecd8.js"><link rel="prefetch" href="/tech-snail/assets/js/20.40ffc78d.js"><link rel="prefetch" href="/tech-snail/assets/js/21.662f2a70.js"><link rel="prefetch" href="/tech-snail/assets/js/22.049a7543.js"><link rel="prefetch" href="/tech-snail/assets/js/23.ec9ab2c0.js"><link rel="prefetch" href="/tech-snail/assets/js/24.475207de.js"><link rel="prefetch" href="/tech-snail/assets/js/25.11a19091.js"><link rel="prefetch" href="/tech-snail/assets/js/26.7d193cab.js"><link rel="prefetch" href="/tech-snail/assets/js/27.e4ee2d28.js"><link rel="prefetch" href="/tech-snail/assets/js/28.64d9a842.js"><link rel="prefetch" href="/tech-snail/assets/js/29.68bc6b62.js"><link rel="prefetch" href="/tech-snail/assets/js/3.7ad10b50.js"><link rel="prefetch" href="/tech-snail/assets/js/30.1e5fb2f9.js"><link rel="prefetch" href="/tech-snail/assets/js/31.076b7bc1.js"><link rel="prefetch" href="/tech-snail/assets/js/32.9f726dd4.js"><link rel="prefetch" href="/tech-snail/assets/js/33.abb74fde.js"><link rel="prefetch" href="/tech-snail/assets/js/34.a83972f8.js"><link rel="prefetch" href="/tech-snail/assets/js/35.40199a15.js"><link rel="prefetch" href="/tech-snail/assets/js/36.94d33be3.js"><link rel="prefetch" href="/tech-snail/assets/js/37.d5232220.js"><link rel="prefetch" href="/tech-snail/assets/js/38.f0c3d2d5.js"><link rel="prefetch" href="/tech-snail/assets/js/39.6fa0a23f.js"><link rel="prefetch" href="/tech-snail/assets/js/4.0ec724f4.js"><link rel="prefetch" href="/tech-snail/assets/js/40.990ab523.js"><link rel="prefetch" href="/tech-snail/assets/js/41.2079bff6.js"><link rel="prefetch" href="/tech-snail/assets/js/42.989a64b0.js"><link rel="prefetch" href="/tech-snail/assets/js/43.1ebb216c.js"><link rel="prefetch" href="/tech-snail/assets/js/44.cf8d94fd.js"><link rel="prefetch" href="/tech-snail/assets/js/45.52d2679a.js"><link rel="prefetch" href="/tech-snail/assets/js/46.ba0e01f7.js"><link rel="prefetch" href="/tech-snail/assets/js/47.3519a60a.js"><link rel="prefetch" href="/tech-snail/assets/js/48.52063db7.js"><link rel="prefetch" href="/tech-snail/assets/js/49.206a426e.js"><link rel="prefetch" href="/tech-snail/assets/js/5.e330bbea.js"><link rel="prefetch" href="/tech-snail/assets/js/50.3d0972e6.js"><link rel="prefetch" href="/tech-snail/assets/js/51.9090993d.js"><link rel="prefetch" href="/tech-snail/assets/js/52.31411922.js"><link rel="prefetch" href="/tech-snail/assets/js/53.c3fe9bce.js"><link rel="prefetch" href="/tech-snail/assets/js/54.fad02bd2.js"><link rel="prefetch" href="/tech-snail/assets/js/55.89783ccc.js"><link rel="prefetch" href="/tech-snail/assets/js/56.2ad7678f.js"><link rel="prefetch" href="/tech-snail/assets/js/57.529d498e.js"><link rel="prefetch" href="/tech-snail/assets/js/58.457d8aec.js"><link rel="prefetch" href="/tech-snail/assets/js/59.3a0dcd84.js"><link rel="prefetch" href="/tech-snail/assets/js/6.4541a9b2.js"><link rel="prefetch" href="/tech-snail/assets/js/60.2c28fc42.js"><link rel="prefetch" href="/tech-snail/assets/js/61.c2f86e6e.js"><link rel="prefetch" href="/tech-snail/assets/js/62.7eed979f.js"><link rel="prefetch" href="/tech-snail/assets/js/63.725fa7f1.js"><link rel="prefetch" href="/tech-snail/assets/js/64.a0c909e8.js"><link rel="prefetch" href="/tech-snail/assets/js/65.9f135cbc.js"><link rel="prefetch" href="/tech-snail/assets/js/66.3844608e.js"><link rel="prefetch" href="/tech-snail/assets/js/67.83aec9f6.js"><link rel="prefetch" href="/tech-snail/assets/js/68.721ee3c7.js"><link rel="prefetch" href="/tech-snail/assets/js/69.fe87e94e.js"><link rel="prefetch" href="/tech-snail/assets/js/7.aa344444.js"><link rel="prefetch" href="/tech-snail/assets/js/70.59ca4431.js"><link rel="prefetch" href="/tech-snail/assets/js/71.90be5950.js"><link rel="prefetch" href="/tech-snail/assets/js/72.6eecc0ba.js"><link rel="prefetch" href="/tech-snail/assets/js/73.5372799c.js"><link rel="prefetch" href="/tech-snail/assets/js/74.9d16355d.js"><link rel="prefetch" href="/tech-snail/assets/js/75.2664da8c.js"><link rel="prefetch" href="/tech-snail/assets/js/76.9728ea6d.js"><link rel="prefetch" href="/tech-snail/assets/js/77.c8c558ae.js"><link rel="prefetch" href="/tech-snail/assets/js/78.724388f1.js"><link rel="prefetch" href="/tech-snail/assets/js/79.e0bc39fd.js"><link rel="prefetch" href="/tech-snail/assets/js/8.4877a2aa.js"><link rel="prefetch" href="/tech-snail/assets/js/9.658bd5cc.js">
    <link rel="stylesheet" href="/tech-snail/assets/css/0.styles.4374f152.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/tech-snail/" class="home-link router-link-active"><!----> <span class="site-name">蜗牛🐌不牛</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/tech-snail/" class="nav-link">Home</a></div><div class="nav-item"><a href="/tech-snail/base/" class="nav-link router-link-active">Base</a></div><div class="nav-item"><a href="/tech-snail/react/" class="nav-link">React</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Snail</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tech-snail/snail-book/" class="nav-link">蜗牛小册子</a></li><li class="dropdown-item"><!----> <a href="/tech-snail/snail/" class="nav-link">乌龟计划</a></li><li class="dropdown-item"><!----> <a href="/tech-snail/four-leaf-clover/" class="nav-link">幸运草</a></li><li class="dropdown-item"><!----> <a href="/tech-snail/deep-sea-area/" class="nav-link">深海区</a></li><li class="dropdown-item"><!----> <a href="/tech-snail/neritic-area/" class="nav-link">浅海区</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/fuxy1011/tech-snail" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/tech-snail/" class="nav-link">Home</a></div><div class="nav-item"><a href="/tech-snail/base/" class="nav-link router-link-active">Base</a></div><div class="nav-item"><a href="/tech-snail/react/" class="nav-link">React</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Snail</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tech-snail/snail-book/" class="nav-link">蜗牛小册子</a></li><li class="dropdown-item"><!----> <a href="/tech-snail/snail/" class="nav-link">乌龟计划</a></li><li class="dropdown-item"><!----> <a href="/tech-snail/four-leaf-clover/" class="nav-link">幸运草</a></li><li class="dropdown-item"><!----> <a href="/tech-snail/deep-sea-area/" class="nav-link">深海区</a></li><li class="dropdown-item"><!----> <a href="/tech-snail/neritic-area/" class="nav-link">浅海区</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/fuxy1011/tech-snail" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Base</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tech-snail/base/" class="sidebar-link">以终为始,目标回溯</a></li><li><a href="/tech-snail/base/js-run-origin.html" class="sidebar-link">js运行机制</a></li><li><a href="/tech-snail/base/css-box.html" class="sidebar-link">盒子模型</a></li><li><a href="/tech-snail/base/self-code.html" class="sidebar-link">手写代码</a></li><li><a href="/tech-snail/base/http.html" class="sidebar-link">HTTP</a></li><li><a href="/tech-snail/base/extends.html" class="sidebar-link">继承</a></li><li><a href="/tech-snail/base/es6.html" class="sidebar-link">ES6</a></li><li><a href="/tech-snail/base/ajax.html" class="sidebar-link">ajax</a></li><li><a href="/tech-snail/base/prototype.html" class="sidebar-link">js原型</a></li><li><a href="/tech-snail/base/closure.html" class="sidebar-link">js闭包</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="作用域和闭包"><a href="#作用域和闭包" aria-hidden="true" class="header-anchor">#</a> 作用域和闭包</h1> <p>作用域和闭包是前端面试中，最可能考查的知识点。例如下面的题目：</p> <blockquote><p>题目：现在有个 HTML 片段，要求编写代码，点击编号为几的链接就alert弹出其编号</p></blockquote> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>编号1，点击我请弹出1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>一般不知道这个题目用闭包的话，会写出下面的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> list <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>实际上执行才会发现始终弹出的是6，这时候就应该通过闭包来解决：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> list <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">alert</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>要理解闭包，就需要我们从「执行上下文」开始讲起。</p> <h2 id="执行上下文"><a href="#执行上下文" aria-hidden="true" class="header-anchor">#</a> 执行上下文</h2> <p>先讲一个关于 变量提升 的知识点，面试中可能会遇见下面的问题，很多候选人都回答错误：</p> <blockquote><p>题目：说出下面执行的结果（这里笔者直接注释输出了）</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>  <span class="token comment">// undefined</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">100</span>

<span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">)</span>  <span class="token comment">// 'zhangsan' 20</span>
<span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    age <span class="token operator">=</span> <span class="token number">20</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
    <span class="token keyword">var</span> age
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这里报错</span>
<span class="token comment">// Uncaught ReferenceError: b is not defined</span>
b <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
</code></pre></div><p>在一段 JS 脚本（即一个 script 标签中）执行之前，要先解析代码（所以说 JS 是解释执行的脚本语言），解析的时候会先创建一个 全局执行上下文 环境，先把代码中即将执行的（内部函数的不算，因为你不知道函数何时执行）变量、函数声明都拿出来。变量先暂时赋值为undefined，函数则先声明好可使用。这一步做完了，然后再开始正式执行程序。再次强调，这是在代码执行之前才开始的工作。</p> <p>我们来看下上面的面试小题目，为什么a是undefined，而b却报错了，实际 JS 在代码执行之前，要「全文解析」，发现var a，知道有个a的变量，存入了执行上下文，而b没有找到var关键字，这时候没有在执行上下文提前「占位」，所以代码执行的时候，提前报到的a是有记录的，只不过值暂时还没有赋值，即为undefined，而b在执行上下文没有找到，自然会报错（没有找到b的引用）。</p> <p>另外，一个函数在执行之前，也会创建一个 函数执行上下文 环境，跟 全局上下文 差不多，不过 函数执行上下文 中会多出this arguments和函数的参数。参数和arguments好理解，这里的this咱们需要专门讲解。</p> <p>总结一下：</p> <ul><li>范围：一段 script、js 文件或者一个函数</li> <li>全局上下文：变量定义，函数声明</li> <li>函数上下文：变量定义，函数声明，this，arguments</li></ul> <h2 id="this"><a href="#this" aria-hidden="true" class="header-anchor">#</a> this</h2> <p>先搞明白一个很重要的概念 —— this的值是在执行的时候才能确认，定义的时候不能确认！ 为什么呢 —— 因为this是执行上下文环境的一部分，而执行上下文需要在代码执行之前确定，而不是定义的时候。看如下例子</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">'A'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
a<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// this === a</span>
a<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'B'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">// this === {name: 'B'}</span>
<span class="token keyword">var</span> fn1 <span class="token operator">=</span> a<span class="token punctuation">.</span>fn
<span class="token function">fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// this === window</span>
</code></pre></div><p>this执行会有不同，主要集中在这几个场景中</p> <ul><li>作为构造函数执行，构造函数中</li> <li>作为对象属性执行，上述代码中a.fn()</li> <li>作为普通函数执行，上述代码中fn1()</li> <li>用于call apply bind，上述代码中a.fn.call({name: 'B'})</li></ul> <p>下面再来讲解下什么是作用域和作用域链，作用域链和作用域也是常考的题目。</p> <blockquote><p>题目：如何理解 JS 的作用域和作用域链</p></blockquote> <h2 id="作用域"><a href="#作用域" aria-hidden="true" class="header-anchor">#</a> 作用域</h2> <p>ES6 之前 JS 没有块级作用域。例如</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'zhangsan'</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
</code></pre></div><p>从上面的例子可以体会到作用域的概念，作用域就是一个独立的地盘，让变量不会外泄、暴露出去。上面的name就被暴露出去了，因此，JS 没有块级作用域，只有全局作用域和函数作用域。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">100</span>
<span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">200</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'global'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
<span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>全局作用域就是最外层的作用域，如果我们写了很多行 JS 代码，变量定义都没有用函数包括，那么它们就全部都在全局作用域中。这样的坏处就是很容易撞车、冲突。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 张三写的代码中</span>
<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>a<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span>

<span class="token comment">// 李四写的代码中</span>
<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
</code></pre></div><p>这就是为何 jQuery、Zepto 等库的源码，所有的代码都会放在(function(){....})()中。因为放在里面的所有变量，都不会被外泄和暴露，不会污染到外面，不会对其他的库或者 JS 脚本造成影响。这是函数作用域的一个体现。</p> <p>附：ES6 中开始加入了块级作用域，使用let定义变量即可，如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">'zhangsan'</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>  <span class="token comment">// 报错，因为let定义的name是在if这个块级作用域</span>
</code></pre></div><h2 id="作用域链"><a href="#作用域链" aria-hidden="true" class="header-anchor">#</a> 作用域链</h2> <p>首先认识一下什么叫做 自由变量 。如下代码中，console.log(a)要得到a变量，但是在当前的作用域中没有定义a（可对比一下b）。当前作用域没有定义的变量，这成为 自由变量 。自由变量如何得到 —— 向父级作用域寻找。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">100</span>
<span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">200</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>如果父级也没呢？再一层一层向上寻找，直到找到全局作用域还是没找到，就宣布放弃。这种一层一层的关系，就是 作用域链 。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">100</span>
<span class="token keyword">function</span> <span class="token constant">F1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">200</span>
    <span class="token keyword">function</span> <span class="token constant">F2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token number">300</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// 自由变量，顺作用域链向父作用域找</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token comment">// 自由变量，顺作用域链向父作用域找</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token comment">// 本作用域的变量</span>
    <span class="token punctuation">}</span>
    <span class="token constant">F2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token constant">F1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="闭包"><a href="#闭包" aria-hidden="true" class="header-anchor">#</a> 闭包</h2> <p>讲完这些内容，我们再来看一个例子，通过例子来理解闭包。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token constant">F1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">100</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> f1 <span class="token operator">=</span> <span class="token constant">F1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">200</span>
<span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>自由变量将从作用域链中去寻找，但是 依据的是函数定义时的作用域链，而不是函数执行时，以上这个例子就是闭包。闭包主要有两个应用场景：</p> <ul><li>函数作为返回值，上面的例子就是</li> <li>函数作为参数传递，看以下例子</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token constant">F1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">100</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token constant">F2</span><span class="token punctuation">(</span><span class="token parameter">f1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">200</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> f1 <span class="token operator">=</span> <span class="token constant">F1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token constant">F2</span><span class="token punctuation">(</span>f1<span class="token punctuation">)</span>
</code></pre></div><p>至此，对应着「作用域和闭包」这部分一开始的点击弹出alert的代码再看闭包，就很好理解了。</p> <h2 id="参考网址"><a href="#参考网址" aria-hidden="true" class="header-anchor">#</a> 参考网址</h2> <p><a href="">掘进小册</a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">8 months ago</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/tech-snail/assets/js/app.844d1d9b.js" defer></script><script src="/tech-snail/assets/js/2.79842762.js" defer></script><script src="/tech-snail/assets/js/19.30631a22.js" defer></script>
  </body>
</html>
